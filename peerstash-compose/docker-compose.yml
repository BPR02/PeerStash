name: peerstash
x-meta:
  compose_version: 0.5.0
services:
  networking:
    image: tailscale/tailscale:latest
    container_name: peerstash-tailscale
    hostname: peerstash-${ADMIN_USERNAME}
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-tags=tag:peerstash
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - target: 22
        published: "${SSH_PORT}"
        protocol: tcp
    restart: unless-stopped
    volumes:
      - type: bind
        source: ${TAILSCALE_DATA}
        target: /var/lib/tailscale
        bind:
          create_host_path: true
    cap_add:
      - net_admin
    privileged: false
    cpu_shares: 90
    deploy:
      resources:
        limits:
          memory: 15841M
    command: []
  storage:
    image: drakkan/sftpgo:v2-alpine-slim
    container_name: peerstash-sftp
    network_mode: service:networking
    environment:
      - SFTPGO_SFTPD__PASSWORD_AUTHENTICATION=false
      - SFTPGO_SFTPD__KEYBOARD_INTERACTIVE_AUTHENTICATION=false
      - SFTPGO_HTTPD__BINDINGS__0__ADDRESS=127.0.0.1
      - SFTPGO_HTTPD__BINDINGS__0__ENABLE_WEB_ADMIN=0
      - SFTPGO_HTTPD__BINDINGS__0__ENABLE_WEB_CLIENT=0
      - SFTPGO_DATA_PROVIDER__CREATE_DEFAULT_ADMIN=true
      - SFTPGO_DEFAULT_ADMIN_USERNAME=${ADMIN_USERNAME}
      - SFTPGO_DEFAULT_ADMIN_PASSWORD=${ADMIN_PASSWORD}
    volumes:
      - type: bind
        source: ${PEERSTASH_SFTP}/data
        target: /srv/sftpgo/data
        bind:
          create_host_path: true
      - type: bind
        source: ${PEERSTASH_SFTP}/config
        target: /var/lib/sftpgo
        bind:
          create_host_path: true
    depends_on:
      - networking
    restart: unless-stopped
  control:
    image: ghcr.io/bpr02/peerstash-control:latest
    container_name: peerstash-control
    network_mode: service:networking
    environment:
      - USERNAME=${ADMIN_USERNAME}
      - PASSWORD=${ADMIN_PASSWORD}
      - DEFAULT_QUOTA_GB=${DEFAULT_QUOTA_GB}
      - TZ=${TZ}
    volumes:
      - type: bind
        source: ${PEERSTASH_ROOT_TARGET}
        target: /mnt/peerstash_root
        read_only: true
      - type: bind
        source: ${PEERSTASH_CONTROL}/config
        target: /var/lib/peerstash
        bind:
          create_host_path: true
      - type: bind
        source: ${PEERSTASH_SFTP}/config
        target: /var/lib/sftpgo
        read_only: true
      - type: bind
        source: ${PEERSTASH_CONTROL}/data
        target: /srv/peerstash/data
        bind:
          create_host_path: true
      - type: bind
        source: ${PEERSTASH_CONTROL}/restored_data
        target: /mnt/peerstash_restore
        bind:
          create_host_path: true
      - type: bind
        source: ${PEERSTASH_CONTROL}/data/restic_cache
        target: /root/.cache/restic
        bind:
          create_host_path: true
    restart: unless-stopped
    privileged: false
    cpu_shares: 90
    deploy:
      resources:
        limits:
          memory: 15841M
    command: []
    devices:
      - /dev/fuse:/dev/fuse
    security_opt:
      - apparmor:unconfined
    cap_add:
      - sys_admin
    depends_on:
      - networking
      - storage
